import pandas as pd
import numpy as np
import talib as ta

pd.set_option('display.max_rows', 100)

data = [['1691709000000', '29443', '29443.5', '29438.5', '29440.5', '245.859', '7238384.659'], ['1691709300000', '29440.5', '29440.5', '29434.5', '29437.5', '274.565', '8082300.946'], ['1691709600000', '29437.5', '29441.5', '29437.5', '29441', '242.013', '7125015.5325'], ['1691709900000', '29441', '29450.5', '29441', '29446.5', '253.252', '7456781.012'], ['1691710200000', '29446.5', '29447', '29440', '29441', '317.119', '9336647.8545'], ['1691710500000', '29441', '29441.5', '29439.5', '29440', '380.164', '11192136.355'], ['1691710800000', '29440', '29442', '29438.5', '29439', '348.482', '10259127.732'], ['1691711100000', '29439', '29439', '29438', '29439', '334.433', '9845194.8255'], ['1691711400000', '29439', '29444', '29438.5', '29443.5', '455.806', '13420315.832'], ['1691711700000', '29443.5', '29444', '29438', '29439.5', '281.834', '8297913.622'], ['1691712000000', '29439.5', '29440', '29438', '29439', '294.459', '8668535.552'], ['1691712300000', '29439', '29442', '29438.5', '29441.5', '280.717', '8264644.083'], ['1691712600000', '29441.5', '29446', '29441.5', '29445.5', '319.211', '9398817.7055'], ['1691712900000', '29445.5', '29461.5', '29445.5', '29461.5', '376.987', '11103331.292'], ['1691713200000', '29461.5', '29468.5', '29461', '29468', '335.574', '9887738.1595'], ['1691713500000', '29468', '29472', '29468', '29471.5', '295.675', '8713449.555'], ['1691713800000', '29471.5', '29475', '29462.5', '29463', '288.209', '8493274.26'], ['1691714100000', '29463', '29467', '29462.5', '29467', '219.386', '6464029.9765'], ['1691714400000', '29467', '29477', '29467', '29477', '267.119', '7873198.7745'], ['1691714700000', '29477', '29477', '29469', '29469.5', '350.966', '10344378.6375'], ['1691715000000', '29469.5', '29479.5', '29468', '29468.5', '226.895', '6687303.335'], ['1691715300000', '29468.5', '29468.5', '29461', '29464', '237.12', '6986791.7885'], ['1691715600000', '29464', '29464', '29459', '29459', '245.218', '7224389.8345'], ['1691715900000', '29459', '29461', '29457.5', '29460.5', '155.863', '4591563.2495'], ['1691716200000', '29460.5', '29462.5', '29456', '29462', '244.528', '7203682.3745'], ['1691716500000', '29462', '29469.5', '29461.5', '29469', '183.808', '5416372.3975'], ['1691716800000', '29469', '29469.5', '29458', '29458', '119.746', '3527952.8635'], ['1691717100000', '29458', '29458.5', '29449', '29453', '281.279', '8284631.8615'], ['1691717400000', '29453', '29454', '29445.5', '29448', '210.451', '6197969.0775'], ['1691717700000', '29448', '29448.5', '29431.5', '29435.5', '342.011', '10068316.554'], ['1691718000000', '29435.5', '29435.5', '29428.5', '29431.5', '317.323', '9339246.035'], ['1691718300000', '29431.5', '29440.5', '29430', '29440.5', '354.761', '10442397.2205'], ['1691718600000', '29440.5', '29440.5', '29438.5', '29439', '229.67', '6761383.2745'], ['1691718900000', '29439', '29439', '29434.5', '29434.5', '145.704', '4289207.163'], ['1691719200000', '29434.5', '29435', '29420', '29420.5', '297.605', '8757114.473'], ['1691719500000', '29420.5', '29420.5', '29410', '29413', '268.899', '7909569.9775'], ['1691719800000', '29413', '29413', '29411', '29411.5', '279.709', '8226742.189'], ['1691720100000', '29411.5', '29412', '29411', '29411.5', '191.326', '5627215.4995'], ['1691720400000', '29411.5', '29412', '29388', '29392', '447.484', '13156870.847'], ['1691720700000', '29392', '29404.5', '29391.5', '29403', '277.752', '8165556.7195'], ['1691721000000', '29403', '29404', '29398', '29400.5', '217.976', '6408651.8825'], ['1691721300000', '29400.5', '29402', '29390', '29390.5', '138.821', '4081079.2525'], ['1691721600000', '29390.5', '29396.5', '29385', '29395', '216.368', '6359138.92'], ['1691721900000', '29395', '29398.5', '29384', '29386.5', '189.906', '5581466.6785'], ['1691722200000', '29386.5', '29388', '29374', '29374.5', '312.055', '9169244.193'], ['1691722500000', '29374.5', '29378.5', '29340', '29368.5', '538.794', '15821115.8105'], ['1691722800000', '29368.5', '29384', '29346', '29383.5', '384.144', '11280139.8835'], ['1691723100000', '29383.5', '29409.5', '29382', '29409.5', '323.867', '9520006.7935'], ['1691723400000', '29409.5', '29419.5', '29399.5', '29400', '215.014', '6324019.8705'], ['1691723700000', '29400', '29406', '29388', '29388.5', '171.743', '5048912.7115'], ['1691724000000', '29388.5', '29393.5', '29388', '29388.5', '146.471', '4304795.8105'], ['1691724300000', '29388.5', '29402.5', '29388.5', '29400.5', '173.414', '5098144.4045'], ['1691724600000', '29400.5', '29402.5', '29397', '29400.5', '321.666', '9456916.0515'], ['1691724900000', '29400.5', '29401.5', '29386', '29395.5', '429.374', '12621353.9195'], ['1691725200000', '29395.5', '29395.5', '29391', '29392.5', '316.324', '9297821.9375'], ['1691725500000', '29392.5', '29392.5', '29383.5', '29384', '390.328', '11471407.968'], ['1691725800000', '29384', '29387', '29380', '29384.5', '346.607', '10184716.946'], ['1691726100000', '29384.5', '29396', '29384.5', '29395', '323.15', '9497170.32'], ['1691726400000', '29395', '29398.5', '29392', '29397.5', '339.775', '9988298.0705'], ['1691726700000', '29397.5', '29407.5', '29397.5', '29407.5', '456.824', '13430538.983'], ['1691727000000', '29407.5', '29407.5', '29399', '29399.5', '351.212', '10326053.952'], ['1691727300000', '29399.5', '29401.5', '29399', '29401', '288.194', '8473005.372'], ['1691727600000', '29401', '29401.5', '29401', '29401', '292.709', '8605998.47'], ['1691727900000', '29401', '29415', '29401', '29415', '299.68', '8812838.3775'], ['1691728200000', '29415', '29423', '29414.5', '29420', '245.058', '7209628.5245'], ['1691728500000', '29420', '29420.5', '29415.5', '29418', '213.145', '6270047.997'], ['1691728800000', '29418', '29418', '29415.5', '29416', '185.616', '5460200.1185'], ['1691729100000', '29416', '29420.5', '29407', '29407', '166.563', '4899250.5045'], ['1691729400000', '29407', '29413', '29405', '29411.5', '246.623', '7252896.8935'], ['1691729700000', '29411.5', '29414.5', '29402.5', '29410', '204.385', '6010808.1175'], ['1691730000000', '29410', '29411.5', '29390.5', '29393.5', '227.262', '6681604.3125'], ['1691730300000', '29393.5', '29395', '29372', '29386', '301.669', '8862640.6165'], ['1691730600000', '29386', '29386', '29375', '29381.5', '245.742', '7219867.2955'], ['1691730900000', '29381.5', '29383.5', '29381', '29383.5', '188.16', '5528485.8345'], ['1691731200000', '29383.5', '29401.5', '29383.5', '29399', '175.357', '5154379.21'], ['1691731500000', '29399', '29400.5', '29399', '29400.5', '197.424', '5804122.4995'], ['1691731800000', '29400.5', '29409', '29400', '29408.5', '334.815', '9843927.2265'], ['1691732100000', '29408.5', '29423.5', '29408.5', '29421', '657.262', '19334904.5465'], ['1691732400000', '29421', '29436.5', '29419.5', '29428.5', '427.593', '12582124.4705'], ['1691732700000', '29428.5', '29428.5', '29416.5', '29424', '302.296', '8894059.3075'], ['1691733000000', '29424', '29445', '29424', '29444.5', '320.129', '9423303.595'], ['1691733300000', '29444.5', '29446', '29442', '29443', '355.03', '10453201.577'], ['1691733600000', '29443', '29443.5', '29423', '29426', '477.311', '14049053.9055'], ['1691733900000', '29426', '29426', '29418', '29424', '441.983', '13004277.0785'], ['1691734200000', '29424', '29435.5', '29423.5', '29435.5', '324.86', '9561023.312'], ['1691734500000', '29435.5', '29435.5', '29423.5', '29424', '356.607', '10494604.2905'], ['1691734800000', '29424', '29424', '29422.5', '29423', '348.382', '10250616.258'], ['1691735100000', '29423', '29427', '29423', '29424.5', '363.847', '10705905.976'], ['1691735400000', '29424.5', '29424.5', '29417', '29418', '264.647', '7786079.2315'], ['1691735700000', '29418', '29420', '29413.5', '29413.5', '298.807', '8789591.037'], ['1691736000000', '29413.5', '29413.5', '29412', '29412.5', '220.471', '6484632.212'], ['1691736300000', '29412.5', '29415', '29412', '29414', '344.827', '10142363.051'], ['1691736600000', '29414', '29455', '29414', '29448.5', '487.583', '14352275.835'], ['1691736900000', '29448.5', '29451', '29444.5', '29447.5', '496.709', '14626110.9085'], ['1691737200000', '29447.5', '29469.5', '29442', '29451', '644.353', '18979641.7785'], ['1691737500000', '29451', '29451.5', '29438.5', '29439.5', '491.863', '14484973.252'], ['1691737800000', '29439.5', '29445', '29434.5', '29437', '254.585', '7494914.2465'], ['1691738100000', '29437', '29439', '29427.5', '29429.5', '372.59', '10966932.2685'], ['1691738400000', '29429.5', '29430', '29420', '29424.5', '410.684', '12085101.1745'], ['1691738700000', '29424.5', '29426.5', '29423', '29426.5', '125.075', '3680218.1025']]

# 创建DataFrame
columns = ['timestamp', 'open', 'high', 'low', 'close', 'volume', 'amount']
df = pd.DataFrame(data, columns=columns)
df = df.astype({'open': float, 'high': float, 'low': float, 'close': float, 'volume': float, 'amount': float})
df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')


# 计算HLC3
df['hlc3'] = (df['high'] + df['low'] + df['close']) / 3

# 计算SV
df['sv'] = np.where(df['hlc3'].diff() >= 0, df['volume'], -df['volume'])

# 计算KVO
ema_short = ta.EMA(df['sv'], 34)
ema_long = ta.EMA(df['sv'], 55)
df['kvo'] = ema_short - ema_long
close = np.array(df['close'])

def hma(period):
 wma_1 = df['close'].rolling(period//2).apply(lambda x: \
 np.sum(x * np.arange(1, period//2+1)) / np.sum(np.arange(1, period//2+1)), raw=True)
 wma_2 = df['close'].rolling(period).apply(lambda x: \
 np.sum(x * np.arange(1, period+1)) / np.sum(np.arange(1, period+1)), raw=True)
 diff = 2 * wma_1 - wma_2
 hma = diff.rolling(int(np.sqrt(period))).mean()
 return hma

period = 27
df['hma'] = hma(period)
print(df)
